"use strict";(()=>{var e={};e.id=485,e.ids=[485],e.modules={1214:e=>{e.exports=import("drizzle-orm/node-postgres")},1428:e=>{e.exports=import("axios")},3034:(e,t,r)=>{r.d(t,{v:()=>i});let a=require("pino"),i=r.n(a)()({level:"info",transport:{target:"pino-pretty",options:{colorize:!0,translateTime:"HH:MM:ss Z",ignore:"pid,hostname",messageFormat:"{msg} {args}"}}})},11737:e=>{e.exports=import("drizzle-orm")},13592:e=>{e.exports=import("lucia")},29676:e=>{e.exports=import("drizzle-zod")},37750:e=>{e.exports=import("@tanstack/react-start")},43769:e=>{e.exports=require("fast-xml-parser")},55078:e=>{e.exports=import("@lucia-auth/adapter-drizzle")},58025:e=>{e.exports=import("drizzle-orm/pg-core")},60231:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>l,routeModule:()=>c});var i=r(4409),s=r(74600),o=r(46440),n=r(86356),d=e([n]);n=(d.then?(await d)():d)[0];let l=(0,o.M)(n,"default"),u=(0,o.M)(n,"config"),c=new i.PagesAPIRouteModule({definition:{kind:s.A.PAGES_API,page:"/api/auth/cas-callback",pathname:"/api/auth/cas-callback",bundlePath:"",filename:""},userland:n});a()}catch(e){a(e)}})},64939:e=>{e.exports=import("pg")},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},86356:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>o});var i=r(96572),s=e([i]);let n=new(i=(s.then?(await s)():s)[0]).o;async function o(e,t){if("GET"!==e.method)return void t.status(405).json({error:"Method Not Allowed"});let r=new URL(e.url||"",`http://${e.headers.host}`),a=r.searchParams.get("ticket");if(!a)return void t.status(400).json({error:"No ticket provided"});let i=`${r.origin}${r.pathname}`,s=await n.validateTicket(a,i),o=await s.text(),d=Object.fromEntries(s.headers.entries());t.writeHead(s.status,d),t.end(o)}a()}catch(e){a(e)}})},96572:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{o:()=>f});var i=r(4916),s=r(67825),o=r(8256),n=r(70685),d=r(3034),l=r(37750),u=r(1428),c=r(11737),p=r(43769),h=e([l,u,c,i,s,o]);[l,u,c,i,s,o]=h.then?(await h)():h;let m=d.v.child({context:"CASCallback"});class f{redirectToError(e,t){let r=n._.CLIENT_URL,a=new URL(`${r}`);return a.searchParams.set("code",e),t&&a.searchParams.set("detail",t),(0,l.json)(null,{status:302,headers:{Location:a.toString()}})}async validateTicket(e,t){let r=n._.CAS_SERVER_URL_PREFIX,a=`${r}/serviceValidate?ticket=${e}&service=${encodeURIComponent(t)}`;m.info(`Validating CAS ticket: ${e} at ${a}`);try{let e=await u.default.get(a);if(200!==e.status)return m.error(`CAS validation request failed with status ${e.status}:`,e.data),this.redirectToError("CAS_HTTP_ERROR",`Status ${e.status}`);return this.parseValidationResponse(e.data)}catch(e){return m.error("CAS validation failed:",e),this.redirectToError("CAS_NETWORK_ERROR")}}parseValidationResponse(e){return new p.XMLParser({ignoreAttributes:!1,attributeNamePrefix:""}).parse(e)["cas:serviceResponse"]}async handleAuthSuccess(e,t){m.info(`CAS Success for user: ${e}`);let r=await this.getOrCreateUser(e,t);return r?this.createSession(r):(m.error("User ID not determined after lookup/creation."),this.redirectToError("USER_ID_MISSING"))}async getOrCreateUser(e,t){let r=await i.db.query.userTable.findFirst({where:(0,c.eq)(s.userTable.username,e)});if(r){if(m.info(`Found existing user: ${e}, ID: ${r.id}`),["luis.sena@ufba.br","joao.leahy@ufba.br","antoniels@ufba.br","caioviana@ufba.br"].includes(r.email)){let[e]=await i.db.update(s.userTable).set({role:"admin"}).where((0,c.eq)(s.userTable.id,r.id)).returning({id:s.userTable.id});return e.id}return r.id}m.info(`Creating new user: ${e}`);let a=t["cas:mail"]||`${e}@ufba.br`,[o]=await i.db.insert(s.userTable).values({username:e,email:a,role:"student"}).returning({id:s.userTable.id});return o?o.id:(m.error("Failed to create new user after insert attempt."),null)}async createSession(e){let t=n._.CLIENT_URL,r=await o.h.createSession(e,{}),a=o.h.createSessionCookie(r.id);return m.info(`Session created: ${r.id}`),(0,l.json)(null,{status:302,headers:{Location:`${t}/auth/cas-callback`,"Set-Cookie":a.serialize()}})}}a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[938],()=>r(60231));module.exports=a})();